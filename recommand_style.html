{% load static %}
{% csrf_token %} 

<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>風格推薦 - AI 坪數整合版</title>
    <link rel="stylesheet" href="{% static 'css/recommand_style.css' %}">
</head>

<body>
    <header>AI 智能設計風格推薦與坪數估算</header>

    <main>
        <div class="user-info-bar">
            <span>您房間的坪數為:</span>
            <span id="userArea" class="user-area-display">載入中...</span>
            <span>坪</span>
        </div>
        <div class="style-section">
            <h2>設計風格與 AI 建議方案</h2>

            <div class="cards-container" id="cardsContainer">
                <!-- 卡片會由 JavaScript 動態生成 -->
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            const CSRF_TOKEN = '{{ csrf_token }}';

            fetch('/api/ai_recommend_result/')
                .then(res => res.json())
                .then(data => {
                    const userAreaDisplay = document.getElementById('userArea');
                    userAreaDisplay.textContent = data.user_area.toFixed(1);

                    const container = document.getElementById('cardsContainer');

                    data.recommendations.forEach(styleData => {
                        const styleCardContainer = document.createElement('div');
                        styleCardContainer.className = 'style-card-container';

                        const styleCard = document.createElement('div');
                        styleCard.className = 'style-card';
                        styleCard.onclick = () => toggleExpand(styleCard);

                        styleCard.innerHTML = `
                            <div class="card-header">
                                <div class="style-id">Style Code: ${styleData.code}</div>
                                <div class="style-duration">設計週期：約 ${styleData.duration} 天</div>
                            </div>
                            <div class="card-main">
                                <div class="style-info">
                                    <div class="style-date">${new Date().getFullYear()}年 推薦</div>
                                    <div class="style-time">${styleData.style}</div>
                                    <div class="style-location">AI 預估</div>
                                </div>
                                <div class="style-info">
                                    <div class="style-date">空間適用性</div>
                                    <div class="style-time">${styleData.user_area_range || ''}</div>
                                    <div class="style-location">溫馨 • 明亮</div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="style-class">設計風格</div>
                                <div class="style-price">TWD ${Math.min(...styleData.cards.map(c => c.price))} 起</div>
                                <div class="action-icon">→</div>
                            </div>
                        `;

                        const expandSection = document.createElement('div');
                        expandSection.className = 'expand-section';
                        expandSection.style.display = 'none';

                        const recommendationsContainer = document.createElement('div');
                        recommendationsContainer.className = 'recommendations-container';

                        styleData.cards.forEach(cardData => {
                            const cardDiv = document.createElement('div');
                            cardDiv.className = 'recommendation-card';
                            cardDiv.dataset.style = styleData.style;
                            cardDiv.dataset.plan = cardData.plan;

                            cardDiv.innerHTML = `
                                <div class="recommendation-tag">${cardData.plan === 'value' ? '超值' : cardData.plan === 'basic' ? '基本' : '奢華'}</div>
                                <div class="recommendation-price">
                                    <span class="currency">TWD</span>
                                    <span class="amount">${cardData.price}</span>
                                </div>
                                <button class="select-btn">選擇</button>
                                <div class="recommendation-details">
                                    <div class="detail-label">AI 建議最小坪數</div>
                                    <div class="detail-value area-value">${cardData.min_area}-${cardData.max_area} 坪</div>
                                </div>
                                <div class="recommendation-details">
                                    <div class="detail-label">壁紙</div>
                                    <div class="detail-value">${cardData.wallpaper}</div>
                                </div>
                                <div class="recommendation-details">
                                    <div class="detail-label">地板</div>
                                    <div class="detail-value">${cardData.floor}</div>
                                </div>
                                <div class="recommendation-details">
                                    <div class="detail-label">天花板</div>
                                    <div class="detail-value">${cardData.ceiling}</div>
                                </div>
                            `;

                            cardDiv.querySelector('.select-btn').addEventListener('click', function (e) {
                                e.stopPropagation();
                                fetch('/api/ai_recommend/', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': CSRF_TOKEN
                                    },
                                    body: JSON.stringify({
                                        style: cardDiv.dataset.style,
                                        plan: cardDiv.dataset.plan,
                                        area: data.user_area
                                    })
                                })
                                .then(res => res.json())
                                .then(resData => {
                                    alert(`已選擇【${cardDiv.dataset.style}】風格的【${cardDiv.dataset.plan}方案】。\n建議空間: ${cardData.min_area}-${cardData.max_area} 坪`);
                                    window.location.href = `/recommand_detail/?style=${cardDiv.dataset.style}&plan=${cardDiv.dataset.plan}&id=${resData.recommendation_id}`;
                                });
                            });

                            recommendationsContainer.appendChild(cardDiv);
                        });

                        expandSection.appendChild(recommendationsContainer);
                        styleCardContainer.appendChild(styleCard);
                        styleCardContainer.appendChild(expandSection);

                        container.appendChild(styleCardContainer);
                    });

                    highlightSuitableCards(data.user_area);
                })
                .catch(err => console.error('後端推薦資料取得失敗:', err));
        });

        function highlightSuitableCards(userArea) {
            const containers = document.querySelectorAll('.style-card-container');
            let closestDiff = Infinity;
            let bestCard = null;

            containers.forEach(container => {
                const styleCard = container.querySelector('.style-card');
                const minAreas = container.querySelectorAll('.area-value');
                let minAreaForStyle = Infinity;

                minAreas.forEach(el => {
                    const [min] = el.textContent.split('-').map(x => parseInt(x));
                    if (min < minAreaForStyle) minAreaForStyle = min;
                });

                const diff = Math.abs(userArea - minAreaForStyle);
                if (diff < closestDiff) {
                    closestDiff = diff;
                    bestCard = styleCard;
                }

                styleCard.classList.remove('recommended-card');
            });

            if (bestCard) bestCard.classList.add('recommended-card');
        }

        function toggleExpand(card) {
            const container = card.parentElement;
            const expandSection = container.querySelector('.expand-section');
            const actionIcon = card.querySelector('.action-icon');
            const isExpanded = expandSection.classList.contains('show');

            document.querySelectorAll('.expand-section.show').forEach(sec => {
                if (sec !== expandSection) {
                    sec.classList.remove('show');
                    sec.style.display = 'none';
                    sec.closest('.style-card-container').querySelector('.action-icon').textContent = '→';
                }
            });

            if (isExpanded) {
                expandSection.classList.remove('show');
                setTimeout(() => expandSection.style.display = 'none', 300);
                actionIcon.textContent = '→';
            } else {
                expandSection.style.display = 'block';
                setTimeout(() => expandSection.classList.add('show'), 10);
                actionIcon.textContent = '↑';
            }
        }
    </script>
</body>

</html>
