{% load static %}
<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8">
    <title>å®¤å…§è¨­è¨ˆæ¨è–¦ç³»çµ±</title>
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
  </head>
  
<body>
  <header>
    å®¤å…§è¨­è¨ˆæ¨è–¦ç³»çµ±
  </header>

  <main>
    <form class="form-section" id="roomForm">
      <div class="upload-container">
        <label class="upload-box" id="box1-label">
          <span>ä¸Šå‚³åœ–ç‰‡ (å¯¦é«”åœ–)</span>
          <input type="file" name="box1" accept="image/*" onchange="previewImage(event, 'preview1')">
          <img id="preview1" class="preview" />
        </label>

        <label class="upload-box" id="box2-label">
          <span>ä¸Šå‚³åœ–ç‰‡ (å¹³é¢åœ–)</span>
          <input type="file" name="box2" accept="image/*" onchange="previewImage(event, 'preview2')">
          <img id="preview2" class="preview" />
        </label>
      </div>

      <div class="form-item">
        <label>æˆ¿é–“ç¸½åªæ•¸:</label>
        <input type="text" name="room_area" >
      </div>
      <div class="form-item">
        <label>é•·*å¯¬*é«˜:</label>
        <input type="text" name="dimensions" >
      </div>
      <div class="form-item">
        <label>ç¸½é ç®—:(å¿…å¡«)</label>
        <input type="number" name="total_budget" required min="1000"> 
      </div>
      <div class="form-item">
        <label>åˆ†åˆ¥é ç®—:</label>
        <input type="text" name="separate_budget" >
      </div>
      <div class="form-item">
        <label>ç‰¹æ®Šéœ€æ±‚:</label>
        <input type="text" name="special_requirements">
      </div>
      <div class="form-item">
        <label>é¢¨æ ¼:</label>
        <select name="style_name" id="styleSelect" >
          <option value="">è«‹é¸æ“‡é¢¨æ ¼</option>
          {% for style in styles %}
          <option value="{{ style.name }}" data-description="{{ style.description }}">{{ style.name }}</option>
          {% endfor %}
        </select>
        <div id="styleDescription" class="style-description"></div>
      </div>
      <div class="form-item">
        <button type="submit" class="submit-btn">é–‹å§‹æ¨è–¦</button>
      </div>
    </form>
  </main>

  <script>
    // ----------------------------------------
    // åœ–ç‰‡é è¦½èˆ‡æ‹–æ›³åŠŸèƒ½
    // ----------------------------------------
    function previewImage(event, previewId) {
      const file = event.target.files[0];
      displayImage(file, previewId);
    }

    function displayImage(file, previewId) {
      if (file && file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.getElementById(previewId);
          img.src = e.target.result;
          img.style.display = 'block';
          img.previousElementSibling.style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
    }

    function enableDragAndDrop(labelId, inputSelector) {
      const label = document.getElementById(labelId);
      const input = label.querySelector(inputSelector);
      const previewId = label.querySelector('img').id;

      label.addEventListener("dragover", (e) => {
        e.preventDefault();
        label.classList.add("dragover");
      });

      label.addEventListener("dragleave", () => {
        label.classList.remove("dragover");
      });

      label.addEventListener("drop", (e) => {
        e.preventDefault();
        label.classList.remove("dragover");
        const file = e.dataTransfer.files[0];
        if (file) {
          input.files = e.dataTransfer.files;
          displayImage(file, previewId);
        }
      });
    }

    enableDragAndDrop("box1-label", "input[name='box1']");
    enableDragAndDrop("box2-label", "input[name='box2']");

    // é¢¨æ ¼é¸æ“‡äº‹ä»¶
    document.getElementById('styleSelect').addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const description = selectedOption.getAttribute('data-description');
      const descriptionDiv = document.getElementById('styleDescription');
      
      if (description && description !== '') {
        descriptionDiv.textContent = description;
        descriptionDiv.style.display = 'block';
      } else {
        descriptionDiv.style.display = 'none';
      }
    });

    // ----------------------------------------
    // è¡¨å–®æäº¤ï¼šAI æ¨è–¦ä¸¦å¸¶å›åªæ•¸
    // ----------------------------------------
    document.getElementById('roomForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const submitBtn = this.querySelector('.submit-btn');
      const originalText = submitBtn.textContent;
      const formData = new FormData(this); 

      submitBtn.textContent = 'AIåˆ†æä¸­...';
      submitBtn.disabled = true;

      fetch('/api/ai_recommend/', { 
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(errorData => {
            throw new Error(errorData.error || `ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
          });
        }
        return response.json();
      })
      .then(result => {
        console.log('ğŸ› Debug: AIæ¨è–¦çµæœ:', result);

        if (result.success) {
          const area = result.area; // Gemini å›å‚³åªæ•¸

          localStorage.setItem('aiRecommendation', JSON.stringify(result));
          
          alert('AIæ¨è–¦å®Œæˆï¼æ­£åœ¨è·³è½‰åˆ°æ¨è–¦é é¢...');

          // å¸¶ä¸Š area åƒæ•¸è·³è½‰
          window.location.href = `/recommand/?area=${encodeURIComponent(area)}`;
        } else {
          throw new Error(result.error || 'AI æœå‹™å…§éƒ¨éŒ¯èª¤');
        }
      })
      .catch(error => {
        console.error('ğŸ› Debug: AIæ¨è–¦éŒ¯èª¤:', error.message);
        alert('AIæ¨è–¦å¤±æ•—ï¼š' + error.message);
      })
      .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      });
    });
  </script>
</body>
</html>
